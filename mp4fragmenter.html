<html>
    <head>
		<title>JavaScript MP4 Reader</title>
        <script src="DataStream.js"></script>
        <script src="mp4fragmenter.js"></script>
		<script>
		var video;
		var mediaSource;
		var mp4box;
		var sb;
		
		window.onload = function () {
			video = document.getElementById('v');
			mediaSource = new MediaSource();
			mediaSource.addEventListener("sourceclose", function () { 
												console.log("Source closed, video error: "+ (video.error ? video.error.code : ""));
												console.log(mediaSource);
											 });
			video.src = window.URL.createObjectURL(mediaSource);
			
			mp4box = new MP4Fragmenter();
			mp4box.DEBUG = false;
		}
		
		function mseplay(url) {
			var frag_index = 1;

			if (mediaSource.readyState != "open") {
				return;
			}
		
			mp4box.onInit = function (d) {
				var codecs = mp4box.inputIsoFile.getCodecs();
				var mime = 'video/mp4; codecs=\"'+codecs+'\"';
				sb = mediaSource.addSourceBuffer(mime);
				console.log("Adding source buffer of type '"+mime+"'");
				console.log(sb);
				console.log(mediaSource);
				sb.addEventListener("updateend", function () { 
													console.log("Init segment appended");
													console.log(sb);
													console.log(mediaSource);
												 });
				d.save('init.mp4');
				sb.appendBuffer(d.buffer);
				/*
				getfile("./mp4-live/mp4-live-h264bl_low-.mp4", function (ab) { 
																	d.buffer = ab.slice(87);
																	d.save('init2.mp4');
																	//var nab = ab.slice(87);
																	//nab.copy(d.buffer);
																	sb.appendBuffer(d.buffer);
																});
				*/
			}
			
			mp4box.onFragment = function (d) {	
/*
				if (sb.updating) {
					sb.addEventListener("updateend", appendNext.bind(sb, d) );
				} else {
					sb.appendBuffer(d.buffer);
				}
				d.save('frag'+frag_index+'.m4s');
				frag_index++;
*/
			}
			mp4box.onError = function (d) {
			}
			
			function appendNext(sb, d) {
				sb.appendBuffer(d.buffer);
			}
			
			mp4box.fragmentURL(url);
		}
			
		</script>
    </head>
	<body>
        <!--button onclick="mseplay('./v2.mp4');">Parse Frag</button-->
        <!--button onclick="mseplay('./video1.mp4');">Parse</button-->
        <button onclick="mseplay('./h264bl.mp4');">Parse</button>
		<video id="v" autoplay controls> </video>
	</body>
</html>