<html>
    <head>
		<title>JavaScript MP4 Reader</title>
        <script src="DataStream.js"></script>
        <script src="mp4fragmenter.js"></script>
		<script>
		var video;
		var mediaSource;
		var mp4box;
		var sb;
		
		window.onload = function () {
			video = document.getElementById('v');
			mediaSource = new MediaSource();
			video.src = window.URL.createObjectURL(mediaSource);
			mp4box = new MP4Fragmenter();
		}
		
		function msesave() {
			var frag_index = 1;
			
			mp4box.onInit = function (d) {
				console.log("Received init data:"+d);
				d.save('init.mp4');
			}
			mp4box.onFragment = function (d) {
				console.log("Received fragment data:"+d);
				d.save('frag'+frag_index+'.m4s');
				frag_index++;
			}
			mp4box.onError = function (d) {
				console.log("Error during fragmentation:"+d);
			}
		}
		
		function mseplay(url) {
			if (mediaSource.readyState != "open") {
				return;
			}
		
			mp4box.onInit = function (d) {
				var codecs = mp4box.inputIsoFile.getCodecs();
				var mime = "video/mp4;codecs=\""+codecs+"\"";
				sb = mediaSource.addSourceBuffer(mime);
				sb.appendBuffer(d.buffer);
			}
			mp4box.onFragment = function (d) {
				if (sb.updating) {
					sb.addEventListener("updateend", function () { 
														sb.appendBuffer(d.buffer); 
													 });
				} else {
					sb.appendBuffer(d.buffer);
				}
			}
			mp4box.onError = function (d) {
			}
			mp4box.fragmentURL(url);
		}
			
		</script>
    </head>
	<body>
        <button onclick="mseplay('./video_frag.mp4');">Parse Frag</button>
        <button onclick="mseplay('./video1.mp4');">Parse</button>
		<video id="v" autoplay> </video>
	</body>
</html>