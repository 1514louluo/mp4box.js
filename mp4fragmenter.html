<html>
    <head>
		<title>JavaScript MP4 Reader</title>
        <script src="DataStream.js"></script>
        <script src="mp4fragmenter.js"></script>
		<script>
		var video;
		var mediaSource;
		var mp4box;
		var sb;
		
		window.onload = function () {
			video = document.getElementById('v');
			mediaSource = new MediaSource();
			mediaSource.addEventListener("sourceclose", function () { 
												console.log("Source closed, video error: "+ (video.error ? video.error.code : "(none)"));
												console.log(mediaSource);
											 });
			video.src = window.URL.createObjectURL(mediaSource);
			
			mp4box = new MP4Fragmenter();
			mp4box.DEBUG = false;
		}
		
		function mseplay(url) {
			var frag_index = 1;

			if (mediaSource.readyState != "open") {
				return;
			}
		
			function onInitAppended(e) {
				console.log("Init segment appended");
				console.log(sb);
				console.log(mediaSource);
				sb.removeEventListener('updateend', onInitAppended);
				sb.addEventListener('updateend', onUpdateEnd);
				onUpdateEnd();
			}
			
			function printRanges(ranges) 
			{
				var length = ranges.length;
				if (length > 0) {
					var str = "";
					for (var i = 0; i < length; i++) {
					  if (i > 0) str += ",";
					  str += "["+ranges.start(i)+ ","+ranges.end(i)+"]";
					}
					return str;
				} else {
					return "(empty)";
				}
			}
			
			function onUpdateEnd() {
				if (sb.pendingAppends.length > 0 && !sb.updating) {
					console.log("Appending new buffer (sb.buffered = "+printRanges(sb.buffered)+")");
					sb.appendBuffer(sb.pendingAppends.shift());
				}
			}

			mp4box.onInit = function (d) {
				var codecs = mp4box.inputIsoFile.getCodecs();
				var mime = 'video/mp4; codecs=\"'+codecs+'\"';
				sb = mediaSource.addSourceBuffer(mime);
				sb.pendingAppends = new Array();
				console.log("Adding source buffer of type '"+mime+"'");
				console.log(sb);
				console.log(mediaSource);
				sb.addEventListener("updateend", onInitAppended);
				//d.save('init.mp4');
				sb.appendBuffer(d.buffer);
			}
			
			mp4box.onFragment = function (d) {	
				/*d.save('frag'+frag_index+'.m4s');
				frag_index++;*/
				sb.pendingAppends.push(d.buffer);
				onUpdateEnd();
			}
			
			mp4box.onError = function (d) {
			}
						
			getfile(url, chunkArrayBuffer.bind(mp4box));
		}

		function getfile(url, callback)
		{
			var xhr = new XMLHttpRequest;
			xhr.open("GET", url, true);
			xhr.responseType = "arraybuffer";
			xhr.onreadystatechange = function (e) { 
				if (this.readyState == this.DONE) {
					callback(this.response); 
				}
			};
			xhr.send();
		}

		ArrayBuffer.prototype.chunk = function (start, size) {
			var that = new Uint8Array(this);
			if (!size || that.byteLength - start < size) {
				size = that.byteLength - start;
			}
			var result = new ArrayBuffer(size);
			var resultArray = new Uint8Array(result);
			for (var i = 0; i < resultArray.length; i++)
			   resultArray[i] = that[i + start];
			return result;
		}

		ArrayBuffer.prototype.copy = function (ab) {
			var source = new Uint8Array(ab);
			var dest = new Uint8Array(this);
			for (var i = 0; i < dest.length; i++) {
				if (dest[i] != source[i]) { console.log("["+i+"] "+dest[i]+"!="+source[i]); }
				dest[i] = source[i];
			}
		}

		function chunkArrayBuffer(ab){
			var chunkStart;
			var chunkSize = Infinity;
			var length = ab.byteLength;	
			for(chunkStart = 0; chunkStart < length; chunkStart += chunkSize) {	
				/* the following does not seem to work in Chrome, the new buffer length is 0 from the 2nd slice
				buffer = ab.slice(chunkStart, chunkSize); */
				console.log("Chunking input buffer from "+chunkStart+" to "+(chunkStart+chunkSize));
				var abchunk = ab.chunk(chunkStart, chunkSize);
				this.fragment(abchunk);
			}
		}			
		</script>
    </head>
	<body>
        <!--button onclick="mseplay('./v2.mp4');">Parse Frag</button-->
        <!--button onclick="mseplay('./video1.mp4');">Parse</button-->
        <button onclick="mseplay('./h264bl.mp4');">Parse</button>
		<video id="v" autoplay controls> </video>
	</body>
</html>