<html>
    <head>
		<title>JavaScript MP4 Reader/Fragmenter</title>
		<link rel="stylesheet" href="style.css" />
        <script src="DataStream.js"></script>
        <script src="descriptor.js"></script>
        <script src="box.js"></script>
        <script src="isofile.js"></script>
        <script src="mp4box.js"></script>
		<script>
		var mediaSource;
		var infoDiv;
		var mp4box;
		
		window.onload = function () {
			var video = document.getElementById('v');
			infoDiv = document.getElementById('infoDiv');
			mediaSource = new MediaSource();
			mediaSource.video = video;
			mediaSource.addEventListener("sourceopen", onSourceOpen);
			mediaSource.addEventListener("sourceclose", onSourceClose);
			video.src = window.URL.createObjectURL(mediaSource);			
		}
		
		function onSourceClose(e) {
			var ms = e.target;
			console.log("Source closed, video error: "+ (ms.video.error ? ms.video.error.code : "(none)"));
			console.log(ms);
		}

		function onSourceOpen(e) {
			var ms = e.target;
			console.log("Source opened");
			console.log(ms);
			var selector = document.getElementById('s');
			selector.disabled = false;
		}
		
		function onInitAppended(e) {
			var sb = e.target;
			console.log("[SourceBuffer #"+sb.id+"] Init segment append end");
			console.log(sb);
			sb.removeEventListener('updateend', onInitAppended);
			sb.addEventListener('updateend', onUpdateEnd.bind(sb));
			onUpdateEnd.call(sb);
		}

		function onUpdateEnd() {
			function printRanges(ranges) {
				var length = ranges.length;
				if (length > 0) {
					var str = "";
					for (var i = 0; i < length; i++) {
					  if (i > 0) str += ",";
					  str += "["+ranges.start(i)+ ","+ranges.end(i)+"]";
					}
					return str;
				} else {
					return "(empty)";
				}
			}
			if (this.ms.readyState == "open" && this.pendingAppends.length > 0 && !this.updating) {
				console.log("[SourceBuffer #"+this.id+"] Appending new buffer, buffered: "+printRanges(this.buffered));
				this.appendBuffer(this.pendingAppends.shift());
			}
		}
		
		function setUrl(url) {
			var urlInput;
			urlInput = document.getElementById('url');
			urlInput.value = url;
		}
		
		function displayMovieInfo(info) {
			var html = "Movie Info";
			html += "<div>";
			html += "<table>";
			html += "<tr><th>Brands</th><td>"+info.brands+"</td></tr>";
			html += "<tr><th>Creation Date</th><td>"+info.created+"</td></tr>";
			html += "<tr><th>Modified Date</th><td>"+info.modified+"</td></tr>";
			html += "<tr><th>Timescale</th><td>"+info.timescale+"</td></tr>";
			html += "<tr><th>Duration</th><td>"+info.duration+" ("+(info.duration/info.timescale)+"s.)</td></tr>";
			html += "<tr><th>Progressive</th><td>"+info.isProgressive+"</td></tr>";
			html += "<tr><th>Fragmented</th><td>"+info.isFragmented+"</td></tr>";
			html += "<tr><th>MPEG-4 IOD</th><td>"+info.hasIOD+"</td></tr>";
			if (info.isFragmented) {
				html += "<tr><th>Fragmented duration</th><td>"+info.fragment_duration+" ("+(info.fragment_duration/info.timescale)+"s.)</td></tr>";
			}
			html += "</table>";
			html += "Track info";
			html += "<table>";
			html += "<tr>";
			html += "<th>Track #</th>";
			html += "<th>Track ID</th>";
			html += "<th>Alternate Group</th>";
			html += "<th>Creation Date</th>";
			html += "<th>Modified Date</th>";
			html += "<th>Timescale</th>";
			html += "<th>Media Duration</th>";
			html += "<th>Number of frames</th>";
			html += "<th>Codec</th>";
			html += "<th>Language</th>";
			html += "<th>Track Width</th>";
			html += "<th>Track Height</th>";
			html += "<th>Track Layer</th>";
			html += "<th>Video Width</th>";
			html += "<th>Video Height</th>";
			html += "<th>Audio Sample Rate</th>";
			html += "<th>Audio Channel Count</th>";
			html += "<th>Add Source Buffer</th>";
			html += "</tr>";
			for (var i = 0; i < info.tracks.length; i++) {
				html += "<tr>";
				html += "<td>"+(i+1)+"</td>";
				html += "<td>"+info.tracks[i].id+"</td>";
				html += "<td>"+info.tracks[i].alternate_group+"</td>";
				html += "<td>"+info.tracks[i].created+"</td>";
				html += "<td>"+info.tracks[i].modified+"</td>";
				html += "<td>"+info.tracks[i].timescale+"</td>";
				html += "<td>"+info.tracks[i].duration+" ("+(info.tracks[i].duration/info.tracks[i].timescale)+"s.) </td>";
				html += "<td>"+info.tracks[i].nb_samples+"</td>";
				html += "<td>"+info.tracks[i].codec+"</td>";
				html += "<td>"+info.tracks[i].language+"</td>";
				html += "<td>"+info.tracks[i].track_width+"</td>";
				html += "<td>"+info.tracks[i].track_height+"</td>";
				html += "<td>"+info.tracks[i].layer+"</td>";
				html += "<td>"+info.tracks[i].video_width+"</td>";
				html += "<td>"+info.tracks[i].video_height+"</td>";
				html += "<td>"+info.tracks[i].audio_sample_rate+"</td>";
				html += "<td>"+info.tracks[i].audio_channel_count+"</td>";
				html += "<td>"+"<input id=\"addTrack"+i+"\" type=\"checkbox\">"+"</td>";
				html += "</tr>";
			}
			html += "</table>";
			html += "</div>";
			infoDiv.innerHTML = html;
			for (var i = 0; i < info.tracks.length; i++) {
				var checkBox = document.getElementById("addTrack"+i);
				checkBox.addEventListener("change", (function (track_id, codec) { 
					return function (e) {
						var check = e.target;
						if (check.checked) { 
							var mime = 'video/mp4; codecs=\"'+codec+'\"';
							console.log("[SourceBuffer #"+track_id+"] Creation with type '"+mime+"'");
							var sb = mediaSource.addSourceBuffer(mime);
							sb.ms = mediaSource;
							sb.id = track_id;
							mp4box.setFragmentOptions(track_id, sb);
							sb.pendingAppends = new Array();
							document.getElementById("startButton").disabled = false;
						} else {
							console.log("[SourceBuffer #"+track_id+"] Removing buffer");
							mp4box.unsetFragmentOptions(track_id);
							for (var i = 0; i < mediaSource.sourceBuffers.length; i++) {
								var sb = mediaSource.sourceBuffers[i];
								if (sb.id == track_id) {
									mediaSource.removeSourceBuffer(sb);
									break;
								}
							}
							if (mediaSource.sourceBuffers.length==0) document.getElementById("startButton").disabled = true;
						}
					};
				})(info.tracks[i].id, info.tracks[i].codec));
			}
		}

		function load() {
			var url = document.getElementById('url').value;
			
			if (mediaSource.readyState != "open") {
				return;
			}

			mp4box = new MP4Box();
			mp4box.onReady = function (info) {
				if (this.timeoutId) {
					window.clearTimeout(this.timeoutId);
					delete this.timeoutId;
				}				
				console.log("Movie information received");
				displayMovieInfo(info);
			}
						
			mp4box.onError = function (d) {
			}
			
			mp4box.chunkStart = 0;
			mp4box.chunkSize = Infinity;
			mp4box.url = url;
			getfile(url, function (response) { 
							mp4box.input = response; 
							chunkArrayBuffer.call(mp4box); 
						} );
		}
		
		function start() {
			mp4box.onFragment = function (user, buffer) {	
				/*d.save('frag'+frag_index+'.m4s');
				frag_index++;*/
				var sb = user;
				sb.pendingAppends.push(buffer);
				onUpdateEnd.call(sb);
			}

			var initSegs = mp4box.initializeFragmentation();
			for (var i = 0; i < initSegs.length; i++) {
				var sb = initSegs[i].user;
				sb.addEventListener("updateend", onInitAppended);
				sb.appendBuffer(initSegs[i].buffer);
				//var d = new DataStream(initSegs[i].buffer);
				//d.save('init'+i+'.mp4');					
			}
			chunkArrayBuffer.call(mp4box); 
		}		

		function getfile(url, callback) {
			var xhr = new XMLHttpRequest;
			xhr.open("GET", url, true);
			xhr.responseType = "arraybuffer";
			xhr.onreadystatechange = function (e) { 
				if (this.status == 200 && this.readyState == this.DONE) {
					callback(this.response); 
				}
			};
			xhr.send();
		}

		ArrayBuffer.prototype.chunk = function (start, size) {
			var that = new Uint8Array(this);
			if (!size || that.byteLength - start < size) {
				size = that.byteLength - start;
			}
			var result = new ArrayBuffer(size);
			var resultArray = new Uint8Array(result);
			for (var i = 0; i < resultArray.length; i++)
			   resultArray[i] = that[i + start];
			return result;
		}

		ArrayBuffer.prototype.copy = function (ab) {
			var source = new Uint8Array(ab);
			var dest = new Uint8Array(this);
			for (var i = 0; i < dest.length; i++) {
				if (dest[i] != source[i]) { console.log("["+i+"] "+dest[i]+"!="+source[i]); }
				dest[i] = source[i];
			}
		}

		function chunkArrayBuffer(){

			console.log("["+this.url+"] Chunking input buffer from "+this.chunkStart+" to "+(this.chunkStart+this.chunkSize));
			if (this.chunkStart == Infinity) {
				this.flush();
			} else {
				var length = this.input.byteLength;	

				/* the following does not seem to work in Chrome, the new buffer length is 0 from the 2nd slice
				buffer = ab.slice(chunkStart, chunkSize); */
				var abchunk = this.input.chunk(this.chunkStart, this.chunkSize);

				this.appendBuffer(abchunk);
				this.chunkStart += this.chunkSize;
				if (this.chunkStart < length) {
					this.timeoutId = window.setTimeout(chunkArrayBuffer.bind(this), 1000);
				}
			}
		}		
		</script>
    </head>
	<body>
		<div>
			<label>Select or set URL:</label>
			<select id="s" onchange="setUrl(this.value);" disabled onfocus="this.selectedIndex = -1;">
				<option value="./h264bl.mp4">Video Counter (unfragmented, H.264/AVC Baseline)</option>
				<option value="./aaclow.mp4">Audio Bips (unfragmented, AAC)</option>
				<option value="./av.mp4">Multiplexed Audio/Video (unfragmented, H.264/AVC Baseline+AAC)</option>
				<option value="./2v.mp4">2 video (unfragmented, H.264/AVC Baseline)</option>
				<option value="./mp4-onDemand-h264bl_low.mp4">DASH onDemand video (fragmented, H.264/AVC Baseline)</option>
			</select>
			<label>URL:</label>
			<input id="url" type="texte"></input>
			<button onclick="load()">Load Media Info</button>
			<button id="startButton" onclick="start()" disabled>Load Media Data & Play</button>
			<div id="infoDiv">
			</div>
		</div>
		<div>
			<video id="v" autoplay controls> </video>
		<div>
	</body>
</html>